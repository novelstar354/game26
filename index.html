<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>東方風 弾幕STG Lunatic Chaos</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
html,body{
 margin:0;height:100%;background:#020617;color:#e5ecff;
 font-family:system-ui;touch-action:none;
}
.wrap{display:grid;place-items:center;height:100%}
canvas{
 background:#070b1f;border-radius:12px;
 width:min(100vw,360px);
 height:auto;
}
.ui{font-size:12px;margin-top:6px;opacity:.8;text-align:center}
.btn{
 position:fixed;bottom:20px;
 background:#1b2a4a;color:#fff;
 border-radius:50%;width:64px;height:64px;
 display:grid;place-items:center;
 opacity:.75;font-size:14px;
}
#auto{right:20px;bottom:100px}
#bomb{right:20px}
#pause{left:20px}
</style>
</head>
<body>

<div class="wrap">
 <canvas id="c" width="360" height="480"></canvas>
 <div class="ui">PC: WASD/矢印｜Shift低速｜Z発射｜X AUTO<br>スマホ: 左ドラッグ移動｜2本指低速</div>
</div>

<div id="auto" class="btn">AUTO</div>
<div id="bomb" class="btn">BOMB</div>
<div id="pause" class="btn">PAUSE</div>

<script>
/* ===== 基本 ===== */
const c=document.getElementById("c"),ctx=c.getContext("2d");
const W=360,H=480;
const keys={},touch={};
let slowTouch=false;

/* ===== 入力 ===== */
addEventListener("keydown",e=>keys[e.key]=true);
addEventListener("keyup",e=>keys[e.key]=false);

c.addEventListener("touchstart",e=>{
 if(e.touches.length>=2)slowTouch=true;
});
c.addEventListener("touchend",e=>{
 if(e.touches.length<2)slowTouch=false;
});
c.addEventListener("touchmove",e=>{
 let t=e.touches[0];
 let r=c.getBoundingClientRect();
 touch.x=(t.clientX-r.left)/r.width*W;
 touch.y=(t.clientY-r.top)/r.height*H;
});

/* ===== ボタン ===== */
auto.onclick=()=>autoFire=!autoFire;
bomb.onclick=()=>bombUse();
pause.onclick=()=>paused=!paused;

/* ===== 軽量当たり ===== */
const hit=(ax,ay,bx,by,r)=>{
 let dx=ax-bx,dy=ay-by;
 return dx*dx+dy*dy<r*r;
};

/* ===== 状態 ===== */
let bullets=[],shots=[],enemies=[],boss=null;
let frame=0,paused=false,autoFire=true;
let life=3,bombCnt=3,inv=0,score=0;

/* ===== プレイヤー ===== */
const player={x:W/2,y:H-60,r:3,s:3.2,slow:1.4};

/* ===== ショット ===== */
function shoot(){
 if(frame%5!==0)return;
 let y=player.y-8,x=player.x;
 let slow=keys.Shift||slowTouch;
 if(slow){
  [-6,-2,2,6].forEach(dx=>{
   shots.push({x:x+dx,y,vx:0,vy:-6});
  });
 }else{
  shots.push({x:x-8,y,vx:-0.6,vy:-6});
  shots.push({x:x-3,y,vx:-0.2,vy:-6});
  shots.push({x:x+3,y,vx: 0.2,vy:-6});
  shots.push({x:x+8,y,vx: 0.6,vy:-6});
 }
}

/* ===== ボム ===== */
function bombUse(){
 if(bombCnt<=0)return;
 bombCnt--;bullets=[];
}

/* ===== 更新 ===== */
function update(){
 if(paused)return;
 frame++; if(inv>0)inv--;

 let slow=keys.Shift||slowTouch;
 let sp=slow?player.slow:player.s;

 if(touch.x){
  player.x+=(touch.x-player.x)*0.2;
  player.y+=(touch.y-player.y)*0.2;
 }else{
  if(keys.ArrowLeft||keys.a)player.x-=sp;
  if(keys.ArrowRight||keys.d)player.x+=sp;
  if(keys.ArrowUp||keys.w)player.y-=sp;
  if(keys.ArrowDown||keys.s)player.y+=sp;
 }

 player.x=Math.max(10,Math.min(W-10,player.x));
 player.y=Math.max(10,Math.min(H-10,player.y));

 if(autoFire||keys.z||keys.Z)shoot();

 shots.forEach(s=>{s.x+=s.vx;s.y+=s.vy;});
 shots=shots.filter(s=>s.y>-20);

 bullets.forEach(b=>{
  b.x+=b.vx;b.y+=b.vy;
  if(inv<=0&&hit(b.x,b.y,player.x,player.y,b.r+player.r)){
   life--;inv=120;bullets=[];
  }
 });
 bullets=bullets.filter(b=>b.x>-40&&b.x<W+40&&b.y>-40&&b.y<H+40);
 if(bullets.length>900)bullets.length=900;
}

/* ===== 描画 ===== */
function draw(){
 ctx.clearRect(0,0,W,H);
 shots.forEach(s=>{
  ctx.fillStyle="#7df9ff";
  ctx.fillRect(s.x-2,s.y-8,4,8);
 });
 bullets.forEach(b=>{
  ctx.fillStyle="#ff5cff";
  ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();
 });
 if(inv%10<5){
  ctx.fillStyle="#4cc9ff";
  ctx.beginPath();ctx.arc(player.x,player.y,6,0,Math.PI*2);ctx.fill();
  ctx.fillStyle="red";
  ctx.beginPath();ctx.arc(player.x,player.y,player.r,0,Math.PI*2);ctx.fill();
 }
 ctx.fillStyle="#fff";
 ctx.fillText(`LIFE:${life} BOMB:${bombCnt}`,6,H-10);
}

/* ===== ループ ===== */
(function loop(){update();draw();requestAnimationFrame(loop)})();
</script>
</body>
</html>
